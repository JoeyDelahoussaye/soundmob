<!DOCTYPE html>
<html lang="en">

<head>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
  
    body {
      font: 13px Helvetica, Arial;
    }
  
    form {
      background: #000;
      padding: 3px;
      position: fixed;
      bottom: 0;
      width: 100%;
    }
  
    form input {
      border: 0;
      padding: 10px;
      width: 90%;
      margin-right: .5%;
    }
  
    form button {
      width: 9%;
      background: rgb(130, 224, 255);
      border: none;
      padding: 10px;
    }
  
  
  
    #messages {
      list-style-type: none;
      margin: 0;
      padding: 0;
    }
  
    #messages li {
      padding: 5px 10px;
    }
  
    #messages li:nth-child(odd) {
      background: #eee;
    }
  </style>
</head>
<body>
  <div>
    <audio id="audio">here's a mic</audio>
    <audio id="output">here's a mic</audio>
  </div>
  <ul id="messages"></ul>
  <div id="makeroom">
    <input size="35" id="newroom"></input><button id="makeroom">Make Room</button>
  </div>
  <div id="roomwrap">
      <input size="35" id="roomname"></input><button id="station">Room Name</button>
  </div>
  <div id="nickwrap">
      <input size="35" id="nickname"></input><button id="username">User Name</button>
      <!-- <input type="submit"></input> -->
  </div>
  <div id="result"></div>
  <div id="live">
    <div id="subscriber"></div>
    <div id="publisher"></div>
  </div>
  <div id="users"></div>
  <form action="">
    <input id="m" autocomplete="off" /><button id="chat">Send</button>
  </form>
  <script src="https://static.opentok.com/v2/js/opentok.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <!-- <script src="https://rtcmulticonnection.herokuapp.com/dist/RTCMultiConnection.min.js"></script>
  <script src="https://rtcmulticonnection.herokuapp.com/socket.io/socket.io.js"></script> -->
  <script src="https://code.jquery.com/jquery-1.11.1.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/0.3.9/peer.min.js"></script>
  <!-- <script src="/dist/RTCMultiConnection.min.js"></script> -->
  <script>
    var apiKey = "46194612";
      var sessionId = "2_MX40NjE5NDYxMn5-MTUzODY2NzQxMDczNn5lWFR6MGU0bWRMYXN6UlFQd3NYeGFNSmV-fg";
      var token = "T1==cGFydG5lcl9pZD00NjE5NDYxMiZzaWc9NmQ2NDE1MWQxMGU4MDdhNTYyNWY0YjNkOWI5NTdkY2Q5OTQyZDI3NDpzZXNzaW9uX2lkPTJfTVg0ME5qRTVORFl4TW41LU1UVXpPRFkyTnpReE1EY3pObjVsV0ZSNk1HVTBiV1JNWVhONlVsRlFkM05ZZUdGTlNtVi1mZyZjcmVhdGVfdGltZT0xNTM4NjY3NDM2Jm5vbmNlPTAuOTgyMDc4NzkzNjM0OTg3MyZyb2xlPXB1Ymxpc2hlciZleHBpcmVfdGltZT0xNTQxMjU5NDM1JmluaXRpYWxfbGF5b3V0X2NsYXNzX2xpc3Q9";
      var session = OT.initSession(apiKey, sessionId);
      var pubOptions = { videoSource: null };

      // Replace replacementElementId with the ID of the DOM element to replace:
      publisher = OT.initPublisher('live', pubOptions);
      // Connect to the session
      session.connect(token, function (error) {
        // If the connection is successful, publish to the session
        if (error) {
          handleError(error);
        } else {
          session.publish(publisher);
        }
      });
      // var options = { subscribeToAudio: true, subscribeToVideo: false };
      session.on("streamCreated", function (event) {
        session.subscribe(event.stream);
        // session.subscribe(event.stream, audio, options);
      })
    const socket = io('/');
  $(function () {
    // sending chat messages
    $('#chat').click(function () {
    socket.emit('chat message', $('#m').val());
    $('#m').val('');
    return false;
    });

    // sending room
    $('#station').click(function () {
      socket.emit('roomroute', $('#roomname').val());
      return false;
    });

    // sending new room and admin
    $('#makeroom').click(function () {
      socket.emit('newroom', $('#newroom').val());
      return false;
    });

    // sending user
    $('#username').click(function () {
      socket.emit('userid', $('#nickname').val());
      return false;
    });
  var $users = $('#users')
    // listen for new chat messages
      // append them to dom
    socket.on('chat message', function (msg) {
      console.log(msg)
    $('#messages').append($('<li>').text(`${msg.name}: ${msg.msg}`));
      });
      
      // notify room when someone leaves
      socket.on('disconnect', function (info) {
        // update users list
        var html = '';
        for (var i = 0; i < info.users.length; i++) {
          html += info.users[i] + '<br/>'
        }
        $users.html(html);
        // notify that user left
      $('#messages').append($('<li>').text(`${info.name} has left the station`));
      });

      
    // listen for new user
      socket.on('new_user', function(info) {
        // update user list
        var html = '';
        for (var i = 0; i < info.users.length; i++){
          html += info.users[i] + '<br/>'
        }
        $users.html(html);
        // notify others of new user
        $('#messages').append($('<li>').text(`${info.name} is listening`));
      });
 
   
 
  });
//  set constrainsts for media devices
var constraints = { audio: true };
// select the audio element 
const audio = document.querySelector('audio');
  // This function returns a promise that gives us access to the users mic and voice from mic
  navigator.mediaDevices.getUserMedia(constraints).then(function(mediaStream) {
    // setting audio from tag so that the voice 
      var mediaRecorder = new MediaRecorder(mediaStream);
      // create chunks array to store audio data
      mediaRecorder.onstart = function(e) {
          this.chunks = [];
      };
      // push audio data into chunks array
      mediaRecorder.ondataavailable = function(e) {
          this.chunks.push(e.data);
          // socket.emit('sample', e.data);
          var blob = new Blob(this.chunks, { 'type': 'audio/ogg; codecs=opus' });
         // Let us open our database
        var request = window.indexedDB.open("MyTestDatabase", 3);
        // assign audio element's src property to audio blob
        // audio.src = window.webkit.URL.createObjectURL(localStorage.blob);
        // play audio
        // audio.play();
        // emit blob
        socket.emit('sample', {blob: blob, socketid: socket.id})
      };
      mediaRecorder.onstop = function(e) {
        console.log('stopped')
      // convert audio data into sendable audio blob
      };
    // start recorder automatically on page render
    mediaRecorder.start();
    console.log("recorder started");
    // stop recording after 5 seconds
    setTimeout(function() {
          mediaRecorder.stop()
      }, 5000);
  });


// When the client receives a voice message it will play the sound
socket.on('voice', function(arrayBuffer) {
    // convert data blob into audio
    var blob = new Blob([arrayBuffer], { 'type' : 'audio/ogg; codecs=opus' });
    // access audio element on dom
    const audio = document.querySelector('audio');
    // assign audio element's src property to audio blob
    audio.src = window.URL.createObjectURL(blob);
    // play audio
    audio.play();
});

    </script>
</body>
</html>